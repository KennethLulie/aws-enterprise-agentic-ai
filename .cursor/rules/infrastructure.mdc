---
description: Terraform and AWS infrastructure patterns - IaC standards, cost safety, deployment
globs:
  - terraform/**
alwaysApply: false
---

# Infrastructure Rules

## Terraform Module Structure

```
terraform/
‚îú‚îÄ‚îÄ environments/
‚îÇ   ‚îî‚îÄ‚îÄ dev/
‚îÇ       ‚îú‚îÄ‚îÄ main.tf        # Module calls
‚îÇ       ‚îú‚îÄ‚îÄ variables.tf   # Input variables
‚îÇ       ‚îú‚îÄ‚îÄ outputs.tf     # Output values
‚îÇ       ‚îî‚îÄ‚îÄ backend.tf     # State configuration
‚îî‚îÄ‚îÄ modules/
    ‚îú‚îÄ‚îÄ networking/        # VPC, subnets, IGW
    ‚îú‚îÄ‚îÄ ecr/               # Container registry
    ‚îú‚îÄ‚îÄ app-runner/        # Backend service
    ‚îú‚îÄ‚îÄ s3-cloudfront/     # Frontend hosting
    ‚îî‚îÄ‚îÄ secrets/           # IAM for Secrets Manager
```

## Naming Conventions

| Resource Type | Pattern | Example |
|---------------|---------|---------|
| General | `${project}-${env}-${resource}` | `enterprise-agentic-ai-dev-vpc` |
| S3 Buckets | `${project}-${purpose}-${random}` | `enterprise-agentic-ai-frontend-a1b2c3` |
| Secrets | `${project}/${secret-name}` | `enterprise-agentic-ai/demo-password` |

**Tags (required on all resources):**
```hcl
tags = {
  Project     = "enterprise-agentic-ai"
  Environment = var.environment
  ManagedBy   = "terraform"
}
```

## State Management

**Bootstrap resources (created manually, NOT by Terraform):**
- S3 bucket for state: `enterprise-agentic-ai-tfstate-{initials}`
- DynamoDB table: `enterprise-agentic-ai-tflock` (partition key: `LockID`)

**Why manual?** Terraform needs its backend to exist before it can manage anything.

## Backend Configuration Template

**File:** `terraform/environments/{env}/backend.tf`

```hcl
terraform {
  required_version = ">= 1.5.0"

  # See DEVELOPMENT_REFERENCE.md for provider versions
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.0"
    }
  }

  # S3 backend (bucket/table created manually)
  backend "s3" {
    bucket         = "enterprise-agentic-ai-tfstate-{initials}"
    key            = "{env}/terraform.tfstate"
    region         = "us-east-1"
    dynamodb_table = "enterprise-agentic-ai-tflock"
    encrypt        = true
  }
}

provider "aws" {
  region = "us-east-1"

  default_tags {
    tags = {
      Project     = "enterprise-agentic-ai"
      Environment = "{env}"
      ManagedBy   = "terraform"
    }
  }
}
```

**Key points:**
- Backend block is INSIDE the terraform block
- Provider versions reference DEVELOPMENT_REFERENCE.md
- Default tags ensure all resources are tagged consistently

## Verification Commands

**Before committing Terraform changes:**
```bash
cd terraform/environments/dev

# Format check (CI will fail if not formatted)
terraform fmt -check -recursive

# Initialize (downloads providers, configures backend)
terraform init

# Validate syntax and configuration
terraform validate

# Preview changes (always review before apply)
terraform plan
```

**Fix formatting issues:**
```bash
terraform fmt -recursive
```

## Cost Safety Checklist

**Before `terraform apply`:**
1. Run `terraform plan` and review output
2. Check resource count matches expectations
3. Verify no expensive resources appear unexpectedly
4. Use staged apply for safety

**Staged Apply Strategy:**
```bash
# Stage 1: Free resources
terraform apply -target=module.networking

# Stage 2: Near-free
terraform apply -target=module.ecr

# Stage 3: Low-cost
terraform apply -target=module.s3_cloudfront

# Stage 4: Running costs (after Docker image pushed)
terraform apply -target=module.app_runner
```

## Red Flags - STOP If You See

| Resource | Why It's Bad | Monthly Cost |
|----------|--------------|--------------|
| `aws_nat_gateway` | Not needed Phase 1a | ~$32 + data |
| `aws_db_instance` | Use Neon (external) or Aurora Serverless | ~$0-50 |
| `aws_eip` (unattached) | Orphaned resource | $3.60 |
| Multiple `aws_apprunner_service` | Should only be 1 | ~$25 each |

## Avoiding Forced Replacements (CRITICAL)

**When modifying modules for existing infrastructure, ALWAYS check `terraform plan` for:**

| Plan Output | Risk Level | Action |
|-------------|------------|--------|
| `~ update in-place` | ‚úÖ Safe | Proceed |
| `-/+ must be replaced` | üî¥ DANGEROUS | Stop and investigate |
| `+ will be created` | ‚ö†Ô∏è Review | Verify it's intentional |
| `- will be destroyed` | üî¥ DANGEROUS | Stop and investigate |

**Common causes of forced replacement:**

| Resource Type | Field That Forces Replacement | Solution |
|---------------|------------------------------|----------|
| `aws_iam_policy` | `description` | Match existing description exactly |
| `aws_iam_policy` | `name` | Match existing name exactly |
| `aws_iam_role` | `name` | Match existing name exactly |
| `aws_s3_bucket` | `bucket` | Never change bucket name |
| `aws_apprunner_service` | `service_name` | Never change service name |

**Before creating/modifying Terraform for deployed resources:**

1. Run `terraform plan` first to see current state
2. Check deployed resource attributes in AWS Console
3. Match descriptions, names, and immutable fields exactly
4. Re-run `terraform plan` to verify only in-place updates

**Example - IAM Policy description mismatch causes replacement:**
```hcl
# ‚ùå WRONG - Different description forces policy recreation
description = "Allows read access to secrets"  # New wording

# ‚úÖ CORRECT - Match existing description exactly
description = "Allow access to application secrets in Secrets Manager"
```

**Why this matters:** Forced replacement of IAM policies/roles can cause brief service outages where applications lose permissions.

## Module Patterns

**Variables (every module):**
```hcl
variable "project_name" {
  type        = string
  description = "Project name for resource naming"
}

variable "environment" {
  type        = string
  default     = "dev"
}

variable "tags" {
  type        = map(string)
  default     = {}
}
```

**Outputs (every module):**
- Always output resource IDs and ARNs
- Use descriptive names: `vpc_id`, `repository_url`, `service_arn`

## Emergency Rollback

```bash
# Destroy specific module
terraform destroy -target=module.app_runner

# Destroy everything (careful!)
terraform destroy

# Check for orphaned resources after destroy
aws ec2 describe-vpcs --filters "Name=tag:Project,Values=enterprise-agentic-ai"
aws apprunner list-services --region us-east-1
```

‚Üí See [aws.mdc] for AWS configuration
‚Üí See [_project.mdc] for current phase requirements
